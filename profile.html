<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mon profil · Université Centrale</title>
        <link rel="stylesheet" href="style.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    </head>
    <body class="profile-page">
        <div class="profile-container fade-up">
            <header class="profile-header">
                <a href="index.html" class="home-link">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 16 16"
                        aria-hidden="true"
                    >
                        <path
                            d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5Z"
                        />
                        <path
                            d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293l6-6Z"
                        />
                    </svg>
                    <span>Retour à l'accueil</span>
                </a>
                <div class="profile-avatar" id="profile-avatar" aria-hidden="true"></div>
                <h1 class="profile-name" id="profile-name">Chargement…</h1>
                <p class="profile-email" id="profile-email"></p>
                <div class="profile-actions">
                    <button type="button" class="btn btn-secondary" id="logout-btn">
                        Se déconnecter
                    </button>
                </div>
            </header>

            <main class="profile-content" aria-live="polite">
                <nav class="profile-nav" aria-label="Sections du profil">
                    <button
                        type="button"
                        class="profile-tab-btn active"
                        data-tab="personal"
                        aria-controls="profile-section-personal"
                        aria-selected="true"
                    >
                        Informations personnelles
                    </button>
                    <button
                        type="button"
                        class="profile-tab-btn"
                        data-tab="security"
                        aria-controls="profile-section-security"
                        aria-selected="false"
                    >
                        Sécurité
                    </button>
                </nav>

                <div class="profile-sections">
                    <section
                        class="profile-section is-active"
                        id="profile-section-personal"
                        data-tab="personal"
                        aria-labelledby="profile-section-personal-title"
                    >
                        <h3 id="profile-section-personal-title">Informations personnelles</h3>
                        <p>
                            Mettez à jour votre identité pour garder vos dossiers étudiants à
                            jour.
                        </p>
                        <form id="profile-form" class="profile-form" novalidate>
                            <div class="form-group">
                                <label class="form-label" for="profile-name-input"
                                    >Nom complet</label
                                >
                                <input
                                    type="text"
                                    id="profile-name-input"
                                    name="profile-name"
                                    class="form-input"
                                    required
                                    autocomplete="name"
                                />
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    Enregistrer les modifications
                                </button>
                            </div>
                        </form>
                        <div class="form-alert error" id="profile-error"></div>
                        <div class="form-alert success" id="profile-success"></div>
                    </section>

                    <section
                        class="profile-section"
                        id="profile-section-security"
                        data-tab="security"
                        aria-labelledby="profile-section-security-title"
                        hidden
                    >
                        <h3 id="profile-section-security-title">Sécurité du compte</h3>
                        <p>
                            Choisissez un mot de passe robuste pour renforcer la protection de
                            votre espace personnel.
                        </p>
                        <form id="password-form" class="profile-form" novalidate>
                            <div class="form-group">
                                <label class="form-label" for="current-password"
                                    >Mot de passe actuel</label
                                >
                                <input
                                    type="password"
                                    id="current-password"
                                    name="current-password"
                                    class="form-input"
                                    autocomplete="current-password"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="new-password"
                                    >Nouveau mot de passe</label
                                >
                                <input
                                    type="password"
                                    id="new-password"
                                    name="new-password"
                                    class="form-input"
                                    minlength="8"
                                    autocomplete="new-password"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="confirm-new-password"
                                    >Confirmer le nouveau mot de passe</label
                                >
                                <input
                                    type="password"
                                    id="confirm-new-password"
                                    name="confirm-new-password"
                                    class="form-input"
                                    minlength="8"
                                    autocomplete="new-password"
                                    required
                                />
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    Mettre à jour mon mot de passe
                                </button>
                            </div>
                        </form>
                        <div class="form-alert error" id="password-error"></div>
                        <div class="form-alert success" id="password-success"></div>
                    </section>
                </div>
            </main>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
        <script src="auth.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                try {
                    const redirected = await auth.redirectIfNeeded(
                        "login.html",
                        "profile.html",
                    );
                    if (redirected) return;

                    const user = await auth.getCurrentUser();
                    if (!user) {
                        window.location.href = "login.html";
                        return;
                    }

                    const profileNameHeading = document.getElementById("profile-name");
                    const profileEmail = document.getElementById("profile-email");
                    const profileAvatar = document.getElementById("profile-avatar");
                    const profileNameInput = document.getElementById("profile-name-input");
                    const logoutBtn = document.getElementById("logout-btn");

                    const profileError = document.getElementById("profile-error");
                    const profileSuccess = document.getElementById("profile-success");
                    const passwordError = document.getElementById("password-error");
                    const passwordSuccess = document.getElementById("password-success");

                    const tabButtons = document.querySelectorAll(".profile-tab-btn");
                    const sections = document.querySelectorAll(".profile-section");

                    const showAlert = (element, message) => {
                        if (!element) return;
                        element.textContent = message;
                        element.classList.add("is-visible");
                    };

                    const hideAlert = (element) => {
                        if (!element) return;
                        element.classList.remove("is-visible");
                        element.textContent = "";
                    };

                    const computeInitials = (name) => {
                        if (!name) return "?";
                        return name
                            .trim()
                            .split(/\s+/)
                            .map((part) => part.charAt(0).toUpperCase())
                            .join("")
                            .slice(0, 3);
                    };

                    const renderUser = (name, email) => {
                        profileNameHeading.textContent = name || "Profil étudiant";
                        profileEmail.textContent = email || "";
                        profileAvatar.textContent = computeInitials(name);
                        profileNameInput.value = name || "";
                    };

                    const activateTab = (tab) => {
                        tabButtons.forEach((button) => {
                            const isActive = button.dataset.tab === tab;
                            button.classList.toggle("active", isActive);
                            button.setAttribute("aria-selected", String(isActive));
                        });

                        sections.forEach((section) => {
                            const isActive = section.dataset.tab === tab;
                            section.classList.toggle("is-active", isActive);
                            section.hidden = !isActive;
                        });
                    };

                    renderUser(user.name, user.email);

                    tabButtons.forEach((button) => {
                        button.addEventListener("click", () => {
                            activateTab(button.dataset.tab);
                        });
                    });

                    logoutBtn.addEventListener("click", async () => {
                        try {
                            await auth.logout();
                            window.location.href = "login.html";
                        } catch (error) {
                            console.error("Erreur lors de la déconnexion:", error);
                        }
                    });

                    const profileForm = document.getElementById("profile-form");
                    profileForm.addEventListener("submit", async (event) => {
                        event.preventDefault();

                        hideAlert(profileError);
                        hideAlert(profileSuccess);

                        const updatedName = profileNameInput.value.trim();
                        if (!updatedName) {
                            showAlert(profileError, "Merci de renseigner votre nom complet.");
                            return;
                        }

                        const submitButton = profileForm.querySelector('button[type="submit"]');
                        const originalText = submitButton.textContent;

                        submitButton.disabled = true;
                        submitButton.textContent = "Enregistrement...";

                        try {
                            await auth.updateName(updatedName);
                                        user.name = updatedName;
                                        renderUser(updatedName, user.email);
                            showAlert(profileSuccess, "Profil mis à jour avec succès.");
                        } catch (error) {
                            showAlert(
                                profileError,
                                error?.message ||
                                    "Impossible de mettre à jour le profil. Veuillez réessayer.",
                            );
                        } finally {
                            submitButton.disabled = false;
                            submitButton.textContent = originalText;
                        }
                    });

                    const passwordForm = document.getElementById("password-form");
                    passwordForm.addEventListener("submit", async (event) => {
                        event.preventDefault();

                        hideAlert(passwordError);
                        hideAlert(passwordSuccess);

                        const currentPassword = document.getElementById("current-password").value;
                        const newPassword = document.getElementById("new-password").value;
                        const confirmPassword = document.getElementById("confirm-new-password").value;

                        if (newPassword !== confirmPassword) {
                            showAlert(
                                passwordError,
                                "Les nouveaux mots de passe ne correspondent pas.",
                            );
                            return;
                        }

                        const submitButton = passwordForm.querySelector('button[type="submit"]');
                        const originalText = submitButton.textContent;

                        submitButton.disabled = true;
                        submitButton.textContent = "Mise à jour...";

                        try {
                            await auth.updatePassword(newPassword, currentPassword);
                            passwordForm.reset();
                            showAlert(
                                passwordSuccess,
                                "Mot de passe mis à jour avec succès.",
                            );
                        } catch (error) {
                            showAlert(
                                passwordError,
                                error?.message ||
                                    "Impossible de modifier le mot de passe. Veuillez réessayer.",
                            );
                        } finally {
                            submitButton.disabled = false;
                            submitButton.textContent = originalText;
                        }
                    });

                    activateTab("personal");
                } catch (error) {
                    console.error("Erreur lors du chargement du profil:", error);
                }
            });
        </script>
    </body>
</html>