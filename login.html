<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Connexion · Université Centrale</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="auth-page">
    <div class="auth-container fade-up">
      <div class="auth-header">
        <span class="badge">Espace étudiant</span>
        <h1>Connexion</h1>
        <p>Connectez-vous à votre espace personnel</p>
      </div>

      <form id="login-form" class="auth-form">
        <div class="form-group">
          <label for="email" class="form-label">Adresse e-mail</label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-input"
            required
            placeholder="votre@email.com"
            autocomplete="email"
          />
        </div>
        <div class="form-group">
          <label for="password" class="form-label">Mot de passe</label>
          <input
            type="password"
            id="password"
            name="password"
            class="form-input"
            required
            placeholder="Votre mot de passe"
            autocomplete="current-password"
          />
        </div>
        <div class="auth-links">
          <a href="#" id="forgot-password-link">Mot de passe oublié&nbsp;?</a>
        </div>
        <label class="form-checkbox" for="remember">
          <input type="checkbox" id="remember" name="remember" />
          <span>Se souvenir de moi</span>
        </label>
        <button type="submit" class="btn btn-primary btn-block">
          Se connecter
        </button>
      </form>

      <div class="form-alert error" id="error-message"></div>
      <div class="form-alert success" id="success-message"></div>

      <div class="auth-footer">
        <span>Pas encore de compte&nbsp;?</span>
        <a href="signup.html">Créer un compte</a>
      </div>
    </div>

    <div
      class="modal-overlay"
      id="password-recovery-modal"
      aria-hidden="true"
    >
      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="recovery-title"
      >
        <h2 id="recovery-title">Récupération de mot de passe</h2>
        <p>
          Entrez votre adresse e-mail pour recevoir un lien de récupération.
        </p>
        <form id="recovery-form" class="auth-form">
          <div class="form-group">
            <label for="recovery-email" class="form-label">Adresse e-mail</label>
            <input
              type="email"
              id="recovery-email"
              class="form-input"
              required
              placeholder="votre@email.com"
              autocomplete="email"
            />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn btn-secondary"
              id="cancel-recovery"
            >
              Annuler
            </button>
            <button type="submit" class="btn btn-primary">Envoyer</button>
          </div>
        </form>
        <div class="form-alert error" id="recovery-error"></div>
        <div class="form-alert success" id="recovery-success"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script src="auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        auth.redirectIfNeeded("login.html", "profile.html");

        const loginForm = document.getElementById("login-form");
        const errorMessage = document.getElementById("error-message");
        const successMessage = document.getElementById("success-message");
        const forgotPasswordLink = document.getElementById("forgot-password-link");
        const passwordRecoveryModal = document.getElementById("password-recovery-modal");
        const recoveryForm = document.getElementById("recovery-form");
        const cancelRecoveryButton = document.getElementById("cancel-recovery");
        const recoveryError = document.getElementById("recovery-error");
        const recoverySuccess = document.getElementById("recovery-success");

        const showAlert = (element, message) => {
          if (!element) return;
          element.textContent = message;
          element.classList.add("is-visible");
        };

        const hideAlert = (element) => {
          if (!element) return;
          element.classList.remove("is-visible");
          element.textContent = "";
        };

        const toggleModal = (isVisible) => {
          passwordRecoveryModal.classList.toggle("is-visible", isVisible);
          passwordRecoveryModal.setAttribute("aria-hidden", String(!isVisible));
          if (!isVisible) {
            recoveryForm.reset();
            hideAlert(recoveryError);
            hideAlert(recoverySuccess);
          }
        };

        loginForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          hideAlert(errorMessage);
          hideAlert(successMessage);

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const submitButton = loginForm.querySelector('button[type="submit"]');
          const originalButtonText = submitButton.textContent;

          submitButton.disabled = true;
          submitButton.textContent = "Connexion en cours...";

          try {
            await auth.login(email, password);
            showAlert(successMessage, "Connexion réussie ! Redirection...");

            setTimeout(() => {
              window.location.href = "profile.html";
            }, 1000);
          } catch (error) {
            showAlert(
              errorMessage,
              error?.message || "Une erreur est survenue. Veuillez réessayer.",
            );
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
          }
        });

        forgotPasswordLink.addEventListener("click", (event) => {
          event.preventDefault();
          toggleModal(true);
        });

        cancelRecoveryButton.addEventListener("click", () => {
          toggleModal(false);
        });

        passwordRecoveryModal.addEventListener("click", (event) => {
          if (event.target === passwordRecoveryModal) {
            toggleModal(false);
          }
        });

        recoveryForm.addEventListener("submit", async (event) => {
          event.preventDefault();

          hideAlert(recoveryError);
          hideAlert(recoverySuccess);

          const email = document.getElementById("recovery-email").value;

          try {
            await auth.recoverPassword(email);
            showAlert(
              recoverySuccess,
              "Instructions de récupération envoyées à votre adresse e-mail.",
            );

            setTimeout(() => {
              toggleModal(false);
            }, 2800);
          } catch (error) {
            showAlert(
              recoveryError,
              error?.message || "Impossible d'envoyer le lien. Veuillez réessayer.",
            );
          }
        });
      });
    </script>
  </body>
</html>